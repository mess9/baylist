package org.baylist.tests.api;

import org.baylist.api.TodoistFeignClient;
import org.baylist.dto.todoist.api.TaskRequest;
import org.baylist.dto.todoist.api.TaskResponse;
import org.baylist.service.TodoistService;
import org.baylist.tests.BaseTest;
import org.baylist.util.extension.FilToken;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Optional;

import static org.assertj.core.api.Assertions.assertThat;
import static org.awaitility.Awaitility.await;

public class TodoistFeignCloseReopenTest extends BaseTest {

	@Autowired
	TodoistService todoistService;

	@Autowired
	TodoistFeignClient todoistApi;

	@FilToken
	String token;


	@Test
//    @Disabled("тест регулярно падает, надо бы починить")
	public void closeAndReopenTask() {
		String projectId = todoistApi.getProjects(token).stream().filter(p -> p.getName().equals("buylist")).findFirst().orElseThrow().getId();

		TaskRequest newTask = TaskRequest.builder()
				.content("Открытая Таска")
				.projectId(projectId)
				.build();
		TaskResponse createdTask = todoistService.createTask(token, newTask);

		List<TaskResponse> tasksBeforeClosing = todoistApi.getTasksByProject(token, projectId);
		Optional<TaskResponse> taskInProjectBeforeClosing = tasksBeforeClosing.stream()
				.filter(t -> t.getId().equals(createdTask.getId()))
				.findAny();
		assertThat(taskInProjectBeforeClosing).isPresent();

		todoistApi.closeTask(token, createdTask.getId());

		List<TaskResponse> tasksAfterClosing = todoistApi.getTasksByProject(token, projectId);
		Optional<TaskResponse> taskInProjectAfterClosing = tasksAfterClosing.stream()
				.filter(t -> t.getId().equals(createdTask.getId()))
				.findAny();
		assertThat(taskInProjectAfterClosing).isNotPresent();

		todoistApi.reopenTask(token, createdTask.getId());

		List<TaskResponse> tasksAfterReopening = todoistApi.getTasksByProject(token, projectId);
		Optional<TaskResponse> taskInProjectAfterReopening = tasksAfterReopening.stream()
				.filter(t -> t.getId().equals(createdTask.getId()))
				.findAny();
		await().until(taskInProjectAfterReopening::isPresent);
	}
}

